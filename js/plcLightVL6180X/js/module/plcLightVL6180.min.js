const ClassSensor=require("ModuleSensor.min.js"),REG_ADDR={IDENTIFICATION__MODEL_ID:0,IDENTIFICATION__MODEL_REV_MAJOR:1,IDENTIFICATION__MODEL_REV_MINOR:2,IDENTIFICATION__MODULE_REV_MAJOR:3,IDENTIFICATION__MODULE_REV_MINOR:4,IDENTIFICATION__DATE_HI:6,IDENTIFICATION__DATE_LO:7,IDENTIFICATION__TIME:8,SYSTEM__MODE_GPIO0:16,SYSTEM__MODE_GPIO1:17,SYSTEM__HISTORY_CTRL:18,SYSTEM__INTERRUPT_CONFIG_GPIO:20,SYSTEM__INTERRUPT_CLEAR:21,SYSTEM__FRESH_OUT_OF_RESET:22,SYSTEM__GROUPED_PARAMETER_HOLD:23,SYSRANGE__START:24,SYSRANGE__THRESH_HIGH:25,SYSRANGE__THRESH_LOW:26,SYSRANGE__INTERMEASUREMENT_PERIOD:27,SYSRANGE__MAX_CONVERGENCE_TIME:28,SYSRANGE__CROSSTALK_COMPENSATION_RATE:30,SYSRANGE__CROSSTALK_VALID_HEIGHT:33,SYSRANGE__EARLY_CONVERGENCE_ESTIMATE:34,SYSRANGE__PART_TO_PART_RANGE_OFFSET:36,SYSRANGE__RANGE_IGNORE_VALID_HEIGHT:37,SYSRANGE__RANGE_IGNORE_THRESHOLD:38,SYSRANGE__MAX_AMBIENT_LEVEL_MULT:44,SYSRANGE__RANGE_CHECK_ENABLES:45,SYSRANGE__VHV_RECALIBRATE:46,SYSRANGE__VHV_REPEAT_RATE:49,SYSALS__START:56,SYSALS__THRESH_HIGH:58,SYSALS__THRESH_LOW:60,SYSALS__INTERMEASUREMENT_PERIOD:62,SYSALS__ANALOGUE_GAIN:63,SYSALS__INTEGRATION_PERIOD:64,RESULT__RANGE_STATUS:77,RESULT__ALS_STATUS:78,RESULT__INTERRUPT_STATUS_GPIO:79,RESULT__ALS_VAL:80,RESULT__HISTORY_BUFFER_0:82,RESULT__HISTORY_BUFFER_1:84,RESULT__HISTORY_BUFFER_2:86,RESULT__HISTORY_BUFFER_3:88,RESULT__HISTORY_BUFFER_4:90,RESULT__HISTORY_BUFFER_5:92,RESULT__HISTORY_BUFFER_6:94,RESULT__HISTORY_BUFFER_7:96,RESULT__RANGE_VAL:98,RESULT__RANGE_RAW:100,RESULT__RANGE_RETURN_RATE:102,RESULT__RANGE_REFERENCE_RATE:104,RESULT__RANGE_RETURN_SIGNAL_COUNT:108,RESULT__RANGE_REFERENCE_SIGNAL_COUNT:112,RESULT__RANGE_RETURN_AMB_COUNT:116,RESULT__RANGE_REFERENCE_AMB_COUNT:120,RESULT__RANGE_RETURN_CONV_TIME:124,RESULT__RANGE_REFERENCE_CONV_TIME:128,RANGE_SCALER:150,READOUT__AVERAGING_SAMPLE_PERIOD:266,FIRMWARE__BOOTUP:281,FIRMWARE__RESULT_SCALER:288,I2C_SLAVE__DEVICE_ADDRESS:530,INTERLEAVED_MODE__ENABLE:675};class ClassVL6180 extends ClassSensor{constructor(_opts){ClassSensor.call(this,_opts),this.Init(),this._MinPeriod=120}Init(){if(this.SetAddress(this._Address||41),this._Scaling=0,this._ptpOffset=0,this._scalerValues=new Uint16Array([0,253,127,84]),this._ptpOffset=this.Read8bit(REG_ADDR.SYSRANGE__PART_TO_PART_RANGE_OFFSET),1===this.Read8bit(REG_ADDR.SYSTEM__FRESH_OUT_OF_RESET))this._Scaling=1,this.Write8bit(519,1),this.Write8bit(520,1),this.Write8bit(150,0),this.Write8bit(151,253),this.Write8bit(227,0),this.Write8bit(228,4),this.Write8bit(229,2),this.Write8bit(230,1),this.Write8bit(231,3),this.Write8bit(245,2),this.Write8bit(217,5),this.Write8bit(219,206),this.Write8bit(220,3),this.Write8bit(221,248),this.Write8bit(159,0),this.Write8bit(163,60),this.Write8bit(183,0),this.Write8bit(187,60),this.Write8bit(178,9),this.Write8bit(202,9),this.Write8bit(408,1),this.Write8bit(432,23),this.Write8bit(429,0),this.Write8bit(255,5),this.Write8bit(256,5),this.Write8bit(409,5),this.Write8bit(422,27),this.Write8bit(428,62),this.Write8bit(423,31),this.Write8bit(48,0),this.Write8bit(REG_ADDR.SYSTEM__FRESH_OUT_OF_RESET,0);else{var s=this.Read16bit(REG_ADDR.RANGE_SCALER);s===this._scalerValues[3]?this._Scaling=3:s===this._scalerValues[2]?this._Scaling=2:this._Scaling=1,this._ptpOffset*=this._Scaling}this.Configure()}PerformSingle(_ch_num){0===_ch_num?this.Write8bit(REG_ADDR.SYSALS__START,1):1===_ch_num&&this.Write8bit(REG_ADDR.SYSRANGE__START,1)}UpdateValues(){if(this._Channels[0].Status){let ambient=this.Read16bit(REG_ADDR.RESULT__ALS_VAL);ambient=.32*ambient/1.01,this._Channels[0].Value=ambient}if(this._Channels[1].Status){let range=this.Read8bit(REG_ADDR.RESULT__RANGE_VAL);range=255===range?1/0:range,this._Channels[1].Value=range}}Start(_ch_num){if("number"!=typeof _ch_num||_ch_num!==E.clip(_ch_num,0,1))throw new Error("Invalid arg");if(this._Channels[_ch_num].Status=1,!this._Interval){let i=0;this._Interval=setInterval(()=>{0===this._Channels[0].Status&&0==this._Channels[1].Status&&(clearInterval(this._Interval),this._Interval=null),this.UpdateValues(),this.PerformSingle(i),i=this._Channels[0].Status&&this._Channels[1].Status?+!Boolean(i):i,i=this._Channels[i].Status?i:+!Boolean(i)},this._MinPeriod)}return!0}Stop(_ch_num){return"number"==typeof _ch_num&&_ch_num===E.clip(_ch_num,0,1)?(this._Channels[_ch_num].Status=0,!0):!_ch_num&&(this._Channels[0].Status=0,this._Channels[1].Status=0,!0)}Configure(){this.Write8bit(REG_ADDR.READOUT__AVERAGING_SAMPLE_PERIOD,48),this.Write8bit(REG_ADDR.SYSALS__ANALOGUE_GAIN,70),this.Write8bit(REG_ADDR.SYSRANGE__VHV_REPEAT_RATE,255),this.Write16bit(REG_ADDR.SYSALS__INTEGRATION_PERIOD,99),this.Write8bit(REG_ADDR.SYSRANGE__VHV_RECALIBRATE,1),this.Write8bit(REG_ADDR.SYSRANGE__INTERMEASUREMENT_PERIOD,9),this.Write8bit(REG_ADDR.SYSALS__INTERMEASUREMENT_PERIOD,49),this.Write8bit(REG_ADDR.SYSRANGE__MAX_CONVERGENCE_TIME,49),this.Write8bit(REG_ADDR.INTERLEAVED_MODE__ENABLE,0),this.SetScaling(1)}Write8bit(reg,val8bit){this._Bus.writeTo(this._Address,reg>>8&255,255&reg,val8bit)}Write16bit(reg,val16bit){this._Bus.writeTo(this._Address,reg>>8&255,255&reg,val16bit>>8&255,255&val16bit)}Read8bit(reg){var data;return this._Bus.writeTo(this._Address,reg>>8&255,255&reg),this._Bus.readFrom(this._Address,1)[0]}Read16bit(reg){this._Bus.writeTo(this._Address,reg>>8&255,255&reg);var data=this._Bus.readFrom(this._Address,2);return(data[0]<<8)+data[1]}SetAddress(newAddr){this.Write8bit(REG_ADDR.I2C_SLAVE__DEVICE_ADDRESS,127&newAddr),this._Address=newAddr}SetScaling(newScaling){var DefaultCrosstalkValidHeight=20;if(!(newScaling<1||newScaling>3)){this._Scaling=newScaling,this.Write16bit(REG_ADDR.RANGE_SCALER,this._scalerValues[this._Scaling]),this.Write8bit(REG_ADDR.SYSRANGE__PART_TO_PART_RANGE_OFFSET,this._ptpOffset/this._Scaling),this.Write8bit(REG_ADDR.SYSRANGE__CROSSTALK_VALID_HEIGHT,20/this._Scaling);var rce=this.Read8bit(REG_ADDR.SYSRANGE__RANGE_CHECK_ENABLES);this.Write8bit(REG_ADDR.SYSRANGE__RANGE_CHECK_ENABLES,254&rce|1===this._Scaling)}}}exports=ClassVL6180;