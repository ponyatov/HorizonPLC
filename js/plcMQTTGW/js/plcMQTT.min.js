var C={PROTOCOL_LEVEL:4,DEF_PORT:1883,DEF_KEEP_ALIVE:60,DEF_QOS:0,CONNECT_TIMEOUT:1e4,PING_INTERVAL:40},TYPE={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},pakId=Math.floor(65534*Math.random()),RETURN_CODES={0:"ACCEPTED",1:"UNACCEPTABLE_PROTOCOL_VERSION",2:"IDENTIFIER_REJECTED",3:"SERVER_UNAVAILABLE",4:"BAD_USER_NAME_OR_PASSWORD",5:"NOT_AUTHORIZED"};class ClassMQTT{constructor(_options){this.host=_options.host,this.port=_options.port||C.DEF_PORT,this.client_id=_options.client_id||mqttUid(),this.keep_alive=_options.keep_alive||C.DEF_KEEP_ALIVE,this.clean_session=_options.clean_session||!0,this.username=_options.username,this.password=_options.password,this.client=!1,this.connected=!1,this.ping_interval=this.keep_alive<C.PING_INTERVAL?this.keep_alive-5:C.PING_INTERVAL,this.protocol_name=_options.protocol_name||"MQTT",this.protocol_level=createEscapedHex(_options.protocol_level||C.PROTOCOL_LEVEL),this._Proxy=new(require(_options.proxyModule))(this,_options.subs),this.on("error",e=>H.Logger.Service.Log({service:"MQTT GW",lvl:"I",msg:`MQTT client error: ${e}`}))}packetHandler(data){this.partData&&(data=this.partData+data,this.partData="");var dLen=mqttPacketLengthDec(data.substr(1,5)),pLen=dLen.decLen+dLen.lenBy+1;if(data.length<pLen)this.partData=data;else{var pData=data.substr(dLen.lenBy+1,dLen.decLen);data.length>pLen&&this.client.emit("data",data.substr(pLen));var cmd=data.charCodeAt(0),type=cmd>>4;if(type===TYPE.PUBLISH){var qos=(6&cmd)>>1,topic_len=pData.charCodeAt(0)<<8|pData.charCodeAt(1),msg_start=2+topic_len+(qos?2:0),parsedData={topic:pData.substr(2,topic_len),message:pData.substr(msg_start,pData.length-msg_start),dup:(8&cmd)>>3,qos:qos,pid:qos?pData.substr(2+topic_len,2):0,retain:1&cmd};parsedData.qos&&this.client.write(fromCharCode((1==parsedData.qos?TYPE.PUBACK:TYPE.PUBREC)<<4)+""+parsedData.pid),this.emit("publish",parsedData),this.emit("message",parsedData.topic,parsedData.message)}else if(type===TYPE.PUBACK)this.emit("puback",data.charCodeAt(2)<<8|data.charCodeAt(3));else if(type===TYPE.PUBREC)this.client.write(fromCharCode(TYPE.PUBREL<<4|2)+""+getPid(pData));else if(type===TYPE.PUBREL)this.client.write(fromCharCode(TYPE.PUBCOMP<<4)+""+getPid(pData));else if(type===TYPE.PUBCOMP)this.emit("pubcomp",data.charCodeAt(2)<<8|data.charCodeAt(3));else if(type===TYPE.SUBACK)pData.length>0&&(128==pData[pData.length-1]?this.emit("subscribed_fail"):this.emit("subscribed"));else if(type===TYPE.UNSUBACK)this.emit("unsubscribed");else if(type===TYPE.PINGREQ)this.client.write(fromCharCode(TYPE.PINGRESP<<4,0));else if(type===TYPE.PINGRESP)this.emit("ping_reply");else if(type===TYPE.CONNACK){this.ctimo&&clearTimeout(this.ctimo),this.ctimo=void 0,this.partData="";var returnCode=0|pData.charCodeAt(1);if("ACCEPTED"===RETURN_CODES[returnCode])this.connected=!0,this.pintr&&clearInterval(this.pintr),this.pintr=setInterval(this.ping.bind(this),1e3*this.ping_interval),this.emit("connected"),this.emit("connect");else{var mqttError="Connection refused, ";this.connected=!1,mqttError+=returnCode>0&&returnCode<6?RETURN_CODES[returnCode]:"unknown return code: "+returnCode+".",this.emit("error",mqttError)}}else this.emit("error","MQTT unsupported packet type: "+type)}}onConnect(client){this.client=client,client.write(this.mqttConnect(this.client_id)),this.ctimo=setTimeout(()=>{this.ctimo=void 0,this.emit("disconnected"),this.disconnect()},C.CONNECT_TIMEOUT),client.on("data",this.packetHandler.bind(this)),client.on("end",()=>{this._scktClosed()})}connect(client){if(client)this.onConnect();else try{client=require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))}catch(e){this.client=!1,this.emit("error",e.message),this.emit("disconnected")}}_scktClosed(){this.connected&&(this.connected=!1,this.client=!1,this.pintr&&clearInterval(this.pintr),this.ctimo&&clearTimeout(this.ctimo),this.pintr=this.ctimo=void 0,this.emit("disconnected"),this.emit("close"))}disconnect(){if(this.client){try{this.client.write(fromCharCode(TYPE.DISCONNECT<<4,0))}catch(e){return this._scktClosed()}this.client.end(),this.client=!1}}publish(topic,message,opts){if(this.client){opts=opts||{};try{this.client.write(mqttPublish(topic,message.toString(),opts.qos||C.DEF_QOS,(opts.retain?1:0)|(opts.dup?8:0)))}catch(e){this._scktClosed()}}}subscribe(topics,opts){if(this.client){opts=opts||{};var subs=[];"string"==typeof topics&&(topics=[topics]),Array.isArray(topics)?topics.forEach(topic=>{subs.push({topic:topic,qos:opts.qos||C.DEF_QOS})}):Object.keys(topics).forEach(k=>{subs.push({topic:k,qos:topics[k]})}),subs.forEach(sub=>{this.client.write(mqttSubscribe(sub.topic,sub.qos))})}}unsubscribe(topic){this.client&&this.client.write(mqttUnsubscribe(topic))}ping(){if(this.client)try{this.client.write(fromCharCode(TYPE.PINGREQ<<4,0))}catch(e){this._scktClosed()}}createFlagsForConnection(options){var flags=0;return flags|=this.username?128:0,flags|=this.username&&this.password?64:0,createEscapedHex(flags|=options.clean_session?2:0)}mqttConnect(clean){var cmd=TYPE.CONNECT<<4,flags=this.createFlagsForConnection({clean_session:clean}),keep_alive=fromCharCode(this.keep_alive>>8,255&this.keep_alive),payload=mqttStr(this.client_id);return this.username&&(payload+=mqttStr(this.username),this.password&&(payload+=mqttStr(this.password))),mqttPacket(cmd,mqttStr(this.protocol_name)+this.protocol_level+flags+keep_alive,payload)}}var fromCharCode=String.fromCharCode;function mqttStr(s){return fromCharCode(s.length>>8,255&s.length)+s}function mqttPacketLength(length){var encLength="";do{var encByte=127&length;(length>>=7)>0&&(encByte+=128),encLength+=fromCharCode(encByte)}while(length>0);return encLength}function mqttPacketLengthDec(length){var bytes=0,decL=0,lb=0;do{decL|=(127&(lb=length.charCodeAt(bytes)))<<7*bytes++}while(128&lb&&bytes<4);return{decLen:decL,lenBy:bytes}}function mqttPacket(cmd,variable,payload){return fromCharCode(cmd)+mqttPacketLength(variable.length+payload.length)+variable+payload}var mqttUid=function(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return s4()+s4()+s4()}}();function mqttPid(){return pakId=pakId>65534?1:++pakId,fromCharCode(pakId>>8)+fromCharCode(255&pakId)}function getPid(data){return data.substr(0,2)}function mqttPublish(topic,message,qos,flags){var cmd=TYPE.PUBLISH<<4|qos<<1|flags,variable=mqttStr(topic);return mqttPacket(cmd,qos>0?variable+=mqttPid():variable,message)}function mqttSubscribe(topic,qos){var cmd;return mqttPacket(TYPE.SUBSCRIBE<<4|2,mqttPid(),mqttStr(topic)+fromCharCode(qos))}function mqttUnsubscribe(topic){var cmd;return mqttPacket(TYPE.UNSUBSCRIBE<<4|2,mqttPid(),mqttStr(topic))}function createEscapedHex(number){return fromCharCode(parseInt(number.toString(16),16))}exports=ClassMQTT;