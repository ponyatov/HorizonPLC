<div style = "font-family: 'Open Sans', sans-serif; font-size: 16px">

# ModuleSensor
<div style = "color: #555">
    <p align="center">
    <img src="./res/logo.png" width="400" title="hover text">
    </p>
</div>

## Лицензия
////

### Описание
<div style = "color: #555">

Модуль Sensor предназначен для обеспечения разработчиков функционалом для удобной и эффективной работы с датчиками в рамках фреймворка Horizon Automated. 
Наделяет датчики полями и методами, которые покрывают типовые задачи идентификации, управления и считывания данных. Для этого модуль создает унифицированный интерфейс, разделяя объект датчика на измерительные каналы. 
Каждый канал представляет собой отдельную измеряемую датчиком величину и функционал, относящийся к считыванию и обработке этой величины.
Данный подход обеспечивает единообразное взаимодействие с различными типами датчиков, упрощая процесс учета, сбора данных, делегирования команд, а так же сокращая время разработки новых модулей под конкретные модели датчиков. 

Заложенный в модуль функционал включает в себя поэтапную автоматическую обработку значений измерений датчика, что повышает надежность и удобство работы. Этот процесс включает в себя следующие этапы:
- Супрессия: выходные данные подвергаются ограничению с использованием супрессорных функций. Это обеспечивает то, что значения с датчика находятся в заданных пределах, что позволяет учесть границы работы датчика или предотвратить определенные ошибки; 
- Трансформация линейной функцией: в случаях, когда значения с датчика требуют преобразования (например, для корректировки либо перевода значений в другие единицы измерения), применяется линейная функция. Эта функция корректирует значения согласно коэффициентам, которые задает пользователь;
- Фильтрация: для снижения влияния шумов и искажений на измерения применяется фильтрация данных. Этот этап помогает получить стабильные и плавные данные от датчиков;
- Проверка зоны измерений: значения с датчика сверяются с зонами измерений, настраиваемые пользователем. Если значение выходит за пределы заданных зон, это активировать соответствующие реакции в виде коллбэков.

Больше об обработке данных в соответствующем [разделе](./README_DATA_REFINE.md#методы). 

</div>

### Структура модуля датчика
<div style = "color: #555">

Набор классов, обеспечивающих функционал датчика, можно условно поделить на следующие части:
- Основная:
    - ветка классов [ClassBaseSensor](./README_ANCESTOR.md) и [ClassSensor](./README_MIDDLE.md), хранящих в себе поля и методы, общие для всех датчиков;
    - класс [ClassChannelSensor](README_CHANNEL.md), служит интерфейсом для работы с отдельным каналом датчика;
- Сервисная: 
    - [ClassTransform, ClassSuppression и ClassFilter](./README_DATA_REFINE.md) реализует математико-логический аппарат для обработки и корректировки данных с датчика;
    - [ClassAlarms](./README_ALARMS.md) добавляет поддержку зон измерения и алармов (оповещений/сигналов тревоги);  
- Прикладная:
    - классы, наследующиеся от **ClassSensor** и реализующие его функционал для работы с конкретным датчиком. 

<div align='left'>
    <img src="./res/main-diagram.png" alt="Image not found">
</div>

### Концепция измерительного канала
<div style = "color: #555">

Концепция измерительного канала занимает центральное место в работе с сенсорами во фреймворке Horizon Automated. Этот подход позволяет представлять каждый датчик как набор измерительных каналов, где каждый канал отвечает за управление, настройку, сбор и обработку данных по отдельной измеряемой величине. В рамках этой концепции, **ClassChannelSensor** выступает в качестве ключевого компонента, через который осуществляется взаимодействие с каждым каналом, обеспечивая единообразный интерфейс для считывания, обработки и корректировки данных. Этот подход позволяет абстрагироваться от специфики каждого отдельного датчика и сосредоточиться на логике сбора и обработки данных.

</div>

</div>

### Примеры
#### Опрос двухканального датчика с использованием сервисных функций
<div style = "color: #555">

```js

//Создание объекта класса
//*VL610 - класс, который наследуется от ClassSensor (ClassSensor) *
let vl6180_channels = DevicesManager.CreateDevice('00');

//Сохранение ссылок на каналы в переменные
/* Далее все взаимодействие с датчиком выполняется через эти каналы */
const ch0 = vl6180_channels[0];
const ch1 = vl6180_channels[1];

//Установка для 1-го канала ограничителей в 5 и 200 мм
ch1.Suppression.SetLim(5, 200);

//Установка для 1-го канала корректирующей функции f(x) = 0.1 * x 
//для преобразования итогового значения в см из мм.
ch1.Transform.SetLinearFunc(0.1, 0);

// Передача усредняющего фильтра
ch1.Filter.SetFunc(arr => arr.reduce((curr, prev) => curr+prev, 0)/arr.length);
//Установка глубины фильтрации (вместимости буфера) для 1-го канала
ch1.SetAvgCapacity(5);

ch1.EnableAlarms();
ch1.Alarms.SetZones({
    red: {
        low:    5, 
        high:   19,
        cbLow:  (ch) => { console.log(`AN OBSTACLE IS VERY CLOSE: ${ch.Value} cm`); }, 
        cbHigh: (ch) => {  console.log(`NO OBSTACLE AHEAD`); }
    },
    green: {
        cb: (ch) =>     { console.log(`AN OBSTACLE IS CLOSE: ${ch.Value}`); }
    }
});

// Запуск опроса обоих канала
ch0.Start();
ch1.Start();

//Вывод показаний с датчика раз в 1 сек.
let interv = setInterval(() => {
    if (ch0.Status)
        console.log(`${(ch0.Value).toFixed(1)} lux`);
    if (ch1.Status)
        console.log(`${(ch1.Value).toFixed(1)}  cm`);
}, 1000);

//Прекращение опроса 0-го канала через 5 сек.
setTimeout(() => {
    ch0.Stop();
    console.log('ch0 stopped');
}, 3000);
//Прекращение опроса 1-го канала через 10 сек.
setTimeout(() => {
    ch1.Stop();
    console.log('ch1 stopped');
    clearInterval(interv);
}, 10000);
```

#### Результат выполнения:

<div align='left'>
    <img src="./res/example-1.png" alt="Image not found">
</div>

#### Смена единицы измерения температуры на ходу с помощью настройки линейной функции:
```js
//Инициализация канала, измеряющего температуру в °C 
let sht_channels = DevicesManager.CreateDevice('02');
let tmprtCh = sht_channels[0];

//Запуск и вывод показаний
temprtCh.Start();
let post = '°C';
setInterval(() => {
    console.log(`Value = ${(temprtCh.Value).toFixed(2)} ${post}`);
}, 2000);

setTimeout(() => {
    //Настройка перевода значений в Фаренгейты
    temprtCh.Transform.SetLinearFunct(1.8, 32);
    post = 'F';
}, 4000);

```
#### Результат выполнения:

<div align='left'>
    <img src="./res/example-2.png" alt="Image not found">
</div>

</div>

### Зависимости
<div style = "color: #555">

</div>

</div>
    