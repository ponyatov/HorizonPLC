var ENCR_FLAGS=["open","wep","wpa_psk","wpa2_psk","wpa_wpa2_psk"],at,socks=[],sockUDP=[],sockData=["","","","",""],MAXSOCKETS=5;function udpToIPAndPort(data){return{ip:data.charCodeAt(0)+"."+data.charCodeAt(1)+"."+data.charCodeAt(2)+"."+data.charCodeAt(3),port:data.charCodeAt(5)<<8|data.charCodeAt(4),len:data.charCodeAt(7)<<8|data.charCodeAt(6)}}var netCallbacks={create:function(host,port,type,options){if(!at)return-1;var sckt;if(void 0===host&&2!=type)return socks[sckt=MAXSOCKETS]="Wait",sockData[sckt]="",at.cmd(`AT+CIPSERVER=1,${port}\r\n`,1e4,(function(d){"OK"==d?socks[sckt]=!0:(socks[sckt]=void 0,setTimeout((function(){throw new Error("CIPSERVER failed ("+(d||"Timeout")+")")}),0))})),MAXSOCKETS;for(var sckt=0,cmd;void 0!==socks[sckt];)sckt++;if(sckt>=MAXSOCKETS)return-7;if(sockData[sckt]="",socks[sckt]="Wait",2==type)port?cmd=`AT+CIPSTART=${sckt},"UDP",${host},${port},${port},2\r\n`:socks[sckt]="UDP",sockUDP[sckt]=!0;else{let socktype="TCP";options&&"https:"==options.protocol&&(socktype="SSL",80==port&&(port=443)),cmd=`AT+CIPSTART=${sckt},"${socktype}",${JSON.stringify(host)},${port}\r\n`,delete sockUDP[sckt]}return cmd&&at.cmd(cmd,1e4,(function cb(d){if("ALREADY CONNECTED"==d)return cb;"OK"==d&&!0===socks[sckt]||(socks[sckt]=-6)})),sckt},close:function(sckt){"Wait"==socks[sckt]?socks[sckt]="WaitClose":void 0!==socks[sckt]&&(socks[sckt]<0||"UDP"==socks[sckt]?socks[sckt]=void 0:at.cmd((sckt==MAXSOCKETS?"AT+CIPSERVER=0":"AT+CIPCLOSE="+sckt)+"\r\n",1e3,(function(){socks[sckt]=void 0})))},accept:function(){for(var i=0;i<MAXSOCKETS;i++)if("Accept"==socks[i])return socks[i]=!0,i;return-1},recv:function(sckt,maxLen){var r;return sockData[sckt]?(sockData[sckt].length>maxLen?(r=sockData[sckt].substr(0,maxLen),sockData[sckt]=sockData[sckt].substr(maxLen)):(r=sockData[sckt],sockData[sckt]="","DataClose"==socks[sckt]&&(socks[sckt]=void 0)),r):socks[sckt]<0?socks[sckt]:socks[sckt]?"":-1},send:function(sckt,data,type){if(!at)return-1;if(at.isBusy()||"Wait"==socks[sckt])return 0;if(socks[sckt]<0)return socks[sckt];if(!socks[sckt])return-1;var d;if("UDP"==socks[sckt])return d=udpToIPAndPort(data),socks[sckt]="Wait",at.cmd("AT+CIPSTART="+sckt+',"UDP","'+d.ip+'",'+d.port+","+d.port+",2\r\n",1e4,(function(d){"OK"!=d&&(socks[sckt]=-6)})),0;var returnVal=data.length,extra="";return 2==type&&(extra=',"'+(d=udpToIPAndPort(data)).ip+'",'+d.port,data=data.substr(8,d.len),returnVal=8+d.len),at.cmd(`AT+CIPSEND=${sckt},${data.length+extra}\r\n`,2e3,(function cb(d){if("OK"==d)at.register("> ",(function(l){return at.unregister("> "),at.write(data),l.substr(2)}));else if(d!="Recv "+data.length+" bytes"&&"busy s..."!=d)return"SEND OK"==d?("WaitClose"==socks[sckt]&&netCallbacks.close(sckt),void(socks[sckt]=!0)):(socks[sckt]=void 0,void at.unregister("> "));return cb})),socks[sckt]="Wait",returnVal}};function ipdHandler(line){var colon=line.indexOf(":");if(colon<0)return line;var parms=line.substring(5,colon).split(",");parms[1]=0|parms[1];var len=line.length-(colon+1),sckt=parms[0];if(sockUDP[sckt]){var ip=(parms[2]||"0.0.0.0").split(".").map((function(x){return 0|x})),p=0|parms[3];sockData[sckt]+=String.fromCharCode(ip[0],ip[1],ip[2],ip[3],255&p,p>>8,255&len,len>>8)}return len>=parms[1]?(sockData[sckt]+=line.substr(colon+1,parms[1]),line.substr(colon+parms[1]+1)):(sockData[sckt]+=line.substr(colon+1,len),at.getData(parms[1]-len,(function(data){sockData[sckt]+=data})),"")}function sckOpen(ln){var sckt=ln[0];void 0===socks[sckt]&&socks[MAXSOCKETS]?socks[sckt]="Accept":"Wait"==socks[sckt]?socks[sckt]=!0:at.cmd("AT+CIPCLOSE="+sckt+"\r\n",1e3,(function(){socks[sckt]=void 0}))}function sckClosed(ln){socks[ln[0]]=""!=sockData[ln[0]]?"DataClose":void 0}var wifiFuncs={ipdHandler:ipdHandler,debug:function(){return{socks:socks,sockData:sockData}},init:function(callback){at.cmd("ATE0\r\n",1e3,(function cb(d){if("ATE0"==d||""==d)return cb;"OK"==d?at.cmd("AT+CIPMUX=1\r\n",1e3,(function(d){"OK"!=d?callback("CIPMUX failed: "+(d||"Timeout")):at.cmd("AT+CIPDINFO=1\r\n",1e3,(function(){at.cmd("AT+CIPSSLSIZE=4096\r\n",1e3,(function(){callback(null)}))}))})):callback("ATE0 failed: "+(d||"Timeout"))}))},reset:function(callback){at.cmd("\r\nAT+RST\r\n",1e4,(function cb(d){if(void 0===d)callback("No 'ready' after AT+RST");else{if("ready"!=d&&"Ready."!=d)return cb;setTimeout((function(){wifiFuncs.init(callback)}),1e3)}}))},getVersion:function(callback){at.cmd("AT+GMR\r\n",1e3,(function(d){callback(null,d)}))},connect:function(ssid,pass,callback){at.cmd("AT+CWMODE=1\r\n",1e3,(function(cwm){"no change"!=cwm&&"OK"!=cwm?callback("CWMODE failed: "+(cwm||"Timeout")):at.cmd("AT+CWJAP="+JSON.stringify(ssid)+","+JSON.stringify(pass.password)+"\r\n",2e4,(function cb(d){if(["WIFI DISCONNECT","WIFI CONNECTED","WIFI GOT IP","+CWJAP:1"].indexOf(d)>=0)return cb;"OK"!=d?setTimeout(callback,0,"WiFi connect failed: "+(d||"Timeout")):setTimeout(callback,0,null)}))}))},getAPs:function(callback){var aps=[];at.cmdReg("AT+CWLAP\r\n",5e3,"+CWLAP:",(function(d){var ap=d.slice(8,-1).split(",");aps.push({ssid:JSON.parse(ap[1]),enc:ENCR_FLAGS[ap[0]],signal:parseInt(ap[2]),mac:JSON.parse(ap[3])})}),(function(){callback(null,aps)}))},getConnectedAP:function(callback){var con;at.cmdReg("AT+CWJAP?\r\n",1e3,"+CWJAP:",(function(d){con=JSON.parse(d.slice(7))}),(function(){callback(null,con)}))},createAP:function(ssid,key,channel,enc,callback){at.cmd("AT+CWMODE=2\r\n",1e3,(function(cwm){"no change"!=cwm&&"OK"!=cwm&&"WIFI DISCONNECT"!=cwm&&callback("CWMODE failed: "+(cwm||"Timeout"));var encn=enc?ENCR_FLAGS.indexOf(enc):0;encn<0?callback("Encryption type "+enc+" not known - "+ENCR_FLAGS):at.cmd("AT+CWSAP="+JSON.stringify(ssid)+","+JSON.stringify(key)+","+channel+","+encn+"\r\n",5e3,(function(cwm){callback("OK"!=cwm?"CWSAP failed: "+(cwm||"Timeout"):null)}))}))},getConnectedDevices:function(callback){var devs=[];this.at.cmd("AT+CWLIF\r\n",1e3,(function r(d){if("OK"==d)callback(null,devs);else{if(void 0!==d&&"ERROR"!=d){var e=d.split(",");return devs.push({ip:e[0],mac:e[1]}),r}callback("Error")}}))},getIP:function(callback){var ip;at.cmdReg("AT+CIFSR\r\n",1e3,"+CIFSR",(function(d){!ip&&d.indexOf(",")>=0&&(ip=JSON.parse(d.slice(d.indexOf(",")+1)))}),(function(d){"OK"!=d?callback("CIFSR failed: "+d):callback(null,{ip:ip})}))},setHostname:function(hostname,callback){at.cmd("AT+CWHOSTNAME="+JSON.stringify(hostname)+"\r\n",500,callback)},ping:function(addr,callback){var time;at.cmd('AT+PING="'+addr+'"\r\n',1e3,(function cb(d){if(d&&"+"==d[0])return time=d.substr(1),cb;"OK"==d?callback(time):callback()}))},setMDNS:function(hostname,serviceType,port,callback){at.cmd('AT+MDNS=1,"'+hostname+'","'+serviceType+'",'+port+"\r\n",500,(function(d){callback("OK"==d?null:d)}))}};exports.setup=function(usart,connectedCallback){return wifiFuncs.at=at=require("AT").connect(usart),require("NetworkJS").create(netCallbacks),at.register("+IPD",ipdHandler),at.register("+CW",line=>{var end=line.indexOf("\n");return end<0?line:(print("+CW",line),line.substr(end+1))}),at.registerLine("0,CONNECT",sckOpen),at.registerLine("1,CONNECT",sckOpen),at.registerLine("2,CONNECT",sckOpen),at.registerLine("3,CONNECT",sckOpen),at.registerLine("4,CONNECT",sckOpen),at.registerLine("0,CLOSED",sckClosed),at.registerLine("1,CLOSED",sckClosed),at.registerLine("2,CLOSED",sckClosed),at.registerLine("3,CLOSED",sckClosed),at.registerLine("4,CLOSED",sckClosed),at.registerLine("WIFI CONNECTED",(function(){exports.emit("associated")})),at.registerLine("WIFI GOT IP",(function(){exports.emit("connected")})),at.registerLine("WIFI DISCONNECTED",(function(){exports.emit("disconnected")})),wifiFuncs.reset(connectedCallback),wifiFuncs};