function g(a,b){this.socket=null;b=b||{};this.host=a;this.port=b.port||80;this.protocolVersion=b.protocolVersion||13;this.origin=b.origin||"Espruino";this.keepAlive=1E3*b.keepAlive||6E4;this.masking=void 0!==b.masking?b.masking:!0;this.path=b.path||"/";this.protocol=b.protocol;this.lastData="";a=btoa(Math.random().toString(36).substr(2,8)+Math.random().toString(36).substr(2,8));var c=a+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11";this.key={source:a,hashed:btoa(require("crypto").SHA1(c))};
this.connected=b.connected||!1;this.headers=b.headers||{}}var h=String.fromCharCode;g.prototype.initializeConnection=function(){require("net").connect({host:this.host,port:this.port},this.onConnect.bind(this))};g.prototype.onConnect=function(a){this.socket=a;var b=this;a.on("data",this.parseData.bind(this));a.on("close",function(){b.pingTimer&&(clearInterval(b.pingTimer),b.pingTimer=void 0);b.emit("close")});this.handshake()};g.prototype.parseData=function(a){var b=this;this.emit("rawData",a);this.lastData.length&&
(a=this.lastData+a,this.lastData="");if(this.connected)for(;a.length;){var c=2,d=a.charCodeAt(0)&15,f=a.charCodeAt(1)&127;if(126==f)f=a.charCodeAt(3)|a.charCodeAt(2)<<8,c+=2;else if(127==f)throw"Messages >65535 in length unsupported";var e=f+c+(a.charCodeAt(1)&128?4:0);if(e>a.length){this.lastData=a;break}switch(d){case 10:this.emit("pong");break;case 9:this.send("pong",138);this.emit("ping");break;case 8:this.socket.end();break;case 0:case 1:d=[0,0,0,0];a.charCodeAt(1)&128&&(d=[a.charCodeAt(c++),
a.charCodeAt(c++),a.charCodeAt(c++),a.charCodeAt(c++)]);for(var l="",k=0;k<f;k++)l+=String.fromCharCode(a.charCodeAt(c++)^d[k&3]);this.emit("message",l);break;default:console.log("WS: Unknown opcode "+d)}a=a.substr(e)}else-1<a.indexOf(this.key.hashed)&&-1<a.indexOf("\r\n\r\n")&&(this.emit("handshake"),this.pingTimer=setInterval(function(){b.send("ping",137)},this.keepAlive),a=a.substring(a.indexOf("\r\n\r\n")+4),this.connected=!0,this.emit("open")),this.lastData=a};g.prototype.handshake=function(){var a=
["GET "+this.path+" HTTP/1.1","Host: "+this.host,"Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Key: "+this.key.source,"Sec-WebSocket-Version: "+this.protocolVersion,"Origin: "+this.origin];this.protocol&&a.push("Sec-WebSocket-Protocol: "+this.protocol);for(var b in this.headers)this.headers.hasOwnProperty(b)&&a.push(b+": "+this.headers[b]);this.socket.write(a.join("\r\n")+"\r\n\r\n")};g.prototype.send=function(a,b){var c=a.length;125<a.length&&(c=126);this.socket.write(h(void 0===b?129:
b,c+(this.masking?128:0)));126==c&&(this.socket.write(h(a.length>>8)),this.socket.write(h(a.length)));if(this.masking){b=[];c="";for(var d=0;4>d;d++){var f=Math.floor(255*Math.random());b[d]=f;c+=h(f)}for(d=0;d<a.length;d++)c+=h(a.charCodeAt(d)^b[d&3]);this.socket.write(c)}else this.socket.write(a)};g.prototype.close=function(){this.socket.end()};exports=function(a,b){a=new g(a,b);a.initializeConnection();return a};exports.createServer=function(a){var b=require("http").createServer(function(c,d){if(c.headers.Connection&&
0<=c.headers.Connection.indexOf("Upgrade")){var f=c.headers["Sec-WebSocket-Key"];f={Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":btoa(E.toString(require("crypto").SHA1(f+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11")))};c.headers["Sec-WebSocket-Protocol"]&&(f["Sec-WebSocket-Protocol"]=c.headers["Sec-WebSocket-Protocol"]);d.writeHead(101,f);var e=new g(void 0,{masking:!1,connected:!0});e.socket=d;c.on("data",e.parseData.bind(e));c.on("close",function(){clearInterval(e.srvPing);e.srvPing=
void 0;e.emit("close")});e.srvPing=setInterval(function(){e.emit("ping",!0);e.send("ping",137)},e.keepAlive);b.emit("websocket",e)}else a(c,d)});return b}